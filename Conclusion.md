# Discussion

В этой статье формализована на Agda простая модель динамической линковки,
описывающая изменения кода программ и библиотек, производимые линкером. В
этой формализации сформулированы основные свойства динамического
линковщика:

*   Описано, как динамический линковщик меняет layout программы и какие
    элементы он в нее добавляет (функция \F{pltize}).
*   Зная, по какому смещению в неслинкованном объектном файле располагался
    некоторый блок кода, динамический линковщик может сказать, где этот
    блок кода будет располагаться в динамически слинкованной библиотеке
    (функция \F{func}).
*   Зная идентификатор функции (в данной простой реализации это
    просто смещение в объектном файле), динамический линкер может указать
    на соответствующие этой функции элементы GOT и PLT (функции \F{got} и
    \F{plt}). Так как эта информация известна в link-time, становится
    возможным использовать их на этом этапе: заменять вызовы "неизвестных"
    функций на вызовы известных блоков PLT, выполнять link-time
    оптимизации.
*   Заранее известно, какой именно код динамический линковщик генерирует
    для каждой внешней функции (функция \F{plt-stub}), а значит, можно
    рассуждать про семантику этого кода.
*   Корректность работы динамической линковки полагается на корректность
    работы динамического загрузчика, при этом явно формулируется,
    выполнение каких свойств требуется в рантайме (функции \F{GOT[ f
    ]-correctness}, \F{PLT[ f ]-correctness})
*   Доказано, что динамическая линковка не меняет семантику программы.

Эти формальные требования позволяют говорить о корректности выполненной
динамической линковки библиотек и могут служить основой для написания
формально верифицированных динамического линковщика и динамического
загрузчика.

***ABI ленивой линковки***.
Современные библиотеки формата ELF используют так называемую "ленивую"
линковку, позволяющую загружать библиотеки в память при первом обращении к
ним. Это требует изменения кода блоков PLT соответстующим образом, и
нуждается в несколько усложненной формализации.

***Алгоритм линковки***.
Дальше со всем этим хочется сделать формализацию самого процесса заполнения
релокаций, как у Cardelli.

***Алгоритм динамической загрузки***.
Кроме того, еще нужна формализация работы динамического загрузчика, не
связанной с линковкой как таковой: разбор бинарников существующих форматов
(ELF) и, что much more challenging, формализация загрузки бинарного кода в
память и взаимодействие с операционной системой на этом этапе.

***Link-time optimisations***.
Продложение этой работы может существенно повлиять на LTO, который пока
lacks any formal semantics (у меня пока нет пруфов этого, но мне так
кажется). Так же это позволило бы построить тулчейн с CompCert, покрывающий
гарантиями не только трансляцию кода, но и линковку и связанные с ней
оптимизации.

***Typed Assembly Language***.
Помимо этого, это могло бы расширить MTAL, в котором была формализация
статической линковки, но не было формализации динамической линковки.
