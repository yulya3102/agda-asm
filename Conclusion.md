# Discussion

В этой статье формализована на Agda простая модель динамической линковки,
описывающая изменения кода программ и библиотек, производимые линкером. В
этой формализации сформулированы основные свойства динамического
линковщика:

*   Описано, как динамический линковщик меняет layout программы и какие
    элементы он в нее добавляет (функция \F{pltize}).
*   Зная, по какому смещению в неслинкованном объектном файле располагался
    некоторый блок кода, динамический линковщик может сказать, где этот
    блок кода будет располагаться в динамически слинкованной библиотеке
    (функция \F{func}).
*   Зная идентификатор функции (в данной простой реализации это
    просто смещение в объектном файле), динамический линкер может указать
    на соответствующие этой функции элементы GOT и PLT (функции \F{got} и
    \F{plt}). Так как эта информация известна в link-time, становится
    возможным использовать их на этом этапе: заменять вызовы "неизвестных"
    функций на вызовы известных блоков PLT, выполнять link-time
    оптимизации.
*   Заранее известно, какой именно код динамический линковщик генерирует
    для каждой внешней функции (функция \F{plt-stub}), а значит, можно
    рассуждать про семантику этого кода.
*   Корректность работы динамической линковки полагается на корректность
    работы динамического загрузчика, при этом явно формулируется,
    выполнение каких свойств требуется в рантайме (функции \F{GOT[ f
    ]-correctness}, \F{PLT[ f ]-correctness})
*   Доказано, что динамическая линковка не меняет семантику программы.

Эти формальные требования позволяют говорить о корректности выполненной
динамической линковки библиотек и могут служить основой для написания
формально верифицированных динамического линковщика и динамического
загрузчика.

Проведенные исследования могут иметь продолжение в следующих направлениях:
(1) формализация ABI "ленивой" линковки, исползуемой в современных
библиотеках формата ELF; (2) формализация процесса заполнения релокаций
динамическим загрузчиком и его свойств, как это сделано в [@cardelli];
(3) формализация разбора бинарных файлов, загрузки кода в память и
взаимодействия с операционной системой, требуемых для получения realistic
dynamic linker/loader.

Описанные результаты могут повлиять на дальнейшие исследования, связанные
с:

*   ***Link-time optimizations***.

    Продложение этой работы может существенно повлиять на LTO, не имеющего
    на данный момент формально описанной семантики (**TODO: proofs?**).
    Кроме того, это позволило бы построить тулчейн с CompCert, покрывающий
    гарантиями не только трансляцию кода, но и линковку и связанные с ней
    оптимизации.

*   ***Typed Assembly Language***.

    Одно из расширений TAL, описанное в [@mtal], формализует типобезопасную
    статическую линковку. Продолжение данной работы могло бы расширить TAL еще
    сильнее, добавив формализацию типобезопасной динамической линковки.
